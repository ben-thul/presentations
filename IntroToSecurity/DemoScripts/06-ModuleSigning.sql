-- let's say that cross-db chaining is not available.
-- what else can we do?

ALTER DATABASE WorldWideImporters SET DB_CHAINING OFF;
ALTER DATABASE ChainTest SET DB_CHAINING OFF;

USE WorldWideImporters;
GO
IF NOT EXISTS (SELECT * FROM sys.symmetric_keys AS sk WHERE name = '##MS_DatabaseMasterKey##')
    CREATE MASTER KEY ENCRYPTION BY PASSWORD = '$Hhhhhhhhhhhhhhhhhh'
CREATE CERTIFICATE [signingCert] 
    WITH SUBJECT = 'Certificate for code signing'

CREATE USER [signingUser] FROM CERTIFICATE [signingCert];
GRANT SELECT ON Application.Cities TO [signingUser];

DECLARE @password VARCHAR(40) = 'f00bar!23'
select name, 'create certificate ' + QUOTENAME(name) + ' from binary = ' 
    + CONVERT(VARCHAR(MAX), CERTENCODED(CERT_ID(name)), 1)
    + ' with private key ( binary = ' 
    + CONVERT(VARCHAR(MAX), CERTPRIVATEKEY(CERT_ID(name), @password), 1)
    + ', decryption by password = ''' + @password + ''')'
FROM sys.[certificates] AS [c]


USE ChainTest;
GO
-- nothing up my sleeve
EXECUTE AS LOGIN = 'OliverTwist';
GO
-- doesn't work because chaining doesn't work cross-db
EXECUTE dbo.usp_getCities 
GO
REVERT
GO

IF NOT EXISTS (SELECT * FROM sys.symmetric_keys AS sk WHERE name = '##MS_DatabaseMasterKey##')
    CREATE MASTER KEY ENCRYPTION BY PASSWORD = '$Hhhhhhhhhhhhhhhhhh'

-- copy/paste the 'CREATE CERTIFICATE' statement from the other database
-- to create it here

create certificate [signingCert] from binary = 0x308202D6308201BEA0030201020210459F9CB9A0BD7CA04F435CECB683CD85300D06092A864886F70D01010505003027312530230603550403131C436572746966696361746520666F7220636F6465207369676E696E67301E170D3138313130333138343333305A170D3139313130333138343333305A3027312530230603550403131C436572746966696361746520666F7220636F6465207369676E696E6730820122300D06092A864886F70D01010105000382010F003082010A0282010100D2DF1C461148F2C06ABBC75CD57145E3E5B10587A89FD20A4B25397E37C7D0DEBE8048FBA909380507FBD5FC8F2FACFFF972CB686AF6FC1B41827A17021CDE41A21003E899E02A1AA8F71AB8E471498929572BE4D701370D46506823F4275A7184C6B469687AEEB3A5E8C4671FDD94D33091D6A265B60B75F82AA539281D6C6995D7DD911FCDB3B1D9D766644660407FE67B2F6C02DC5988DB82598D47C34096A3A3F035CCE4ECEFE988D639367BBD860572E9F7D81B57EB70564ACA378BFDEFF106908F9464596DDEE50D460E46079F6AB29607EC6F3B427BE1173133F6F7B7D692D593345D0EB87BD3756F2742E99C55C6570B8CDFB615093917A2977767E10203010001300D06092A864886F70D010105050003820101009FC40E0D5D8638604649ACEC9294E717161A4641CEBD48CEE956CFDBDD963AC6AF5E39AAEBCC5FCC60F15D0DA11A8B6CE2F33285837BC472C6A0A30CA431B574E3EEB6939FA9476E000931A535F342739C6E742D49462736D7E9E6DAE4804443046A24049123617AF4CFA280FFBEC97CBD7B229F9D07E5CA145DAC7AA728AC415C8CFF98AE47E08E7F03B8764D5F0A7087C40B90F82C538406C0A99AB69BAA2B349E4CE012EDA79D337CCE1AF3D9E001082BBD031FE2BA46991BA4C99D77E8FECEF3816B163FF81BE05F3128F28575A9D1891AA968A6B147D13803A55C07D856BE161D708D745B3A91589E37711C1977E21FA981D2D41CA50DEDAD78EABA5251 with private key ( binary = 0x1EF1B5B00000000001000000010000001000000094040000F8F69D6A71D84A31662D85B182BB68E50702000000A4000072E354D2B644AFA116F9AF33D16516E3DE949C79D54B5B4E36334E1C057E6F2DC4B3C161E1A074FD84960C2BEE63759A71F3E4B2B698493F39D66D642B6B2E03263B496537C3504B47B6FE2E8FA1153E5BB417F9C26A4CA136999A86C50EE833539256B4AF59621273E7934877BCC3A8744F8030C69E4B8EA5FB313988E621C6B8D84EB4952F3E99CA1635B9D2F1329D05F4EF79647ECBA1BA0965ECBC73245E09A49FF6A1F97135AD47F96D3CDEE0523102C9956C92B32A244866AB6F72C4EA9E657902AA08BEB8097EFAF43EA7A90442CFAFA0E1F9DB5514FCF0F36E4A70D9DD8B165A4E4E5BEE01D42B59C4593C0D3610B4E12EC7129BB1A36A3C85C8D09D55023691D7A646EBCA953903922DEE79EB66A4C3F777124042E6542FB4DD0313CEB291493FBE16E40CCFC3105F3932D2E129A2DEF09A0A87CA4F3E9634BDBC50B07E1AAE9B9C71DCE4BE8C4682C67087EF6036DE3C16E1BEA9D8475798B40F9FEABBC9B661A0FC67A39140CDAA7028434AAA817214C61492B137A023121F72868357D616E952CA02EE7DD14911C8CD9D898D34756DB5AD04F76ADA79883DA4C64A334B8E0D90C90C4D87984D27E73D22569C4784E2C1AC67E5AE4FDFABB5CC9370AAA0D8612301BB2C3B1249BC46A0FD94D466A865010519D36B737699A5C256968BA4F0326A463114335C567EEECB21FC6E7B3E14689D00A26498CECAC781674AFEBC6FC403210540E1DC5142B0216952CF65838B6965BC34EB5BF0992DB31E45EE8E5AA14E3823F2789EFFE7ED28018FA79C0A90BA29D52375EDE4AA35814F74184E170103739AD9EEED6432BA5486A39B1ACFFF4464DF5B16876959A7BD11F3C17CAE4E23AAC334AF804DCFE92E022E75FDF6FC9AEAC93DF22D0215065D737CEFF1DF19F5AE04D674156A8199FEE1273332A827EB15C82CBE94F55E03204471CE1F13C294F5120E4E1C8240D971786DB27CF570CBFB99BCED6550A837BD0E9848FD0E6730C64A550631B77CC61F3912C9D1D20402838AE7749CD637C21840581ED7B9394AE93DCB65EA9B6F27BE1984F9DA09624E7614C324DF2D0F3B015353C092533F91ECC6EF45955F7434DCDC60F8D974CCFDC3164CAB6796591EDC46C142839423CD4A779DC873AB45DCDDFDF31BCB4EF7B5199EAC2AD29E71EC5531184AB8D6E21D5EB981CA863A16E0B9F76634CDEBBFFC81881763ED6C5E0EA97828FEA528F2DBB4D2EE99B7ECCD91D17425F1A140E2B47766CCED71DF003301B49E96982F5B66745F756F53C09ACBA03D4FAC504156EBF067E43D8D910EDABE08EB62B1BB1443E02179D997AC3DDCA5BCD280C0CF93A2F4C304BB42A42DEF6953131CFBF8D86AA25D94D4667E604C9E9EF7657EF3D8439F4E70CFBFFAAADD09DD189A12485791AA91E0F0999233AFC6D25EF557886D33B67AB705C51E364A49F2D39343DECBD42E0C9BB1332913606E020259E37AC69B5E0B00BAC7DFF1E2B430CB60BDD75EA374D66F91895AF19FD9A207B82720F08D8E6593AB3D9C8399E22EC4C9F57AD0C120FFC289F180C3B30BBC81BE7A2921B20519676042D75E0451971E24956C5760E3B8490AEBD86584ADBDBC716AC4900993C7DCED29DD8165C2001EB4CAFBB7E6C732BA8FA9D1, decryption by password = 'f00bar!23')
-- now that we have the same certificate in both locations,
-- we can use it to sign the procedure

ADD SIGNATURE TO dbo.usp_getCities BY CERTIFICATE [signingCert]

EXECUTE AS LOGIN = 'OliverTwist';
GO
-- now that the stored procedure is signed, this works
EXECUTE dbo.usp_getCities 
GO
REVERT
GO